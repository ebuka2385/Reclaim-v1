// https://pris.ly/d/prisma-schema

// ============================================================================
// REQUIRED DATABASE SCHEMA CHANGES - MUST BE COMPLETED FOR APP COMPLETION
// ============================================================================
//
// ALL ITEMS BELOW ARE REQUIRED - Must be completed before app is finished
//
//
//
// After making ALL changes:
//   1. Create a new migration: npx prisma migrate dev --name complete_schema_updates
//   2. Regenerate Prisma client: npx prisma generate
//   3. Test all functionality (claims, items, categories) to ensure everything works
//
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId       String        @id @default(cuid())
  email        String        @unique
  name         String
  createdAt    DateTime      @default(now())
  items        Item[]
  notifications Notification[]
  claims       Claim[]       @relation("UserClaims")
  messages     Message[]     @relation("UserMessages")
  deviceTokens DeviceToken[]
}

model Item {
  itemId      String     @id @default(cuid())
  title       String
  description String
  status      ItemStatus @default(LOST)
  createdAt   DateTime   @default(now())
  userId      String
  user        User       @relation(fields: [userId], references: [userId], onDelete: Cascade)
  archives    Archive[]
  claims      Claim[]
  latitude    Float?
  longitude   Float?
  category    String?

  @@index([userId])
  @@index([status])
  @@index([category])
}

model Notification {
  notifId      String @id @default(cuid())
  userId       String 
  relatedUser         User @relation(fields : [userId], references : [userId], onDelete: Cascade)
  message      String
  timestamp    DateTime @default(now()) 
  read         Boolean @default(false)

  @@index([userId])
}

model Archive {
  archiveId    String   @id @default(cuid())
  itemId       String
  item         Item     @relation(fields: [itemId], references: [itemId], onDelete: Cascade)
  resolvedTime DateTime @default(now())
  reason       String? //Optional field

  @@index([itemId])
}

model Claim {
  claimId   String @id @default(cuid())
  itemId    String
  claimerId String
  finderId  String 
  handedOff Boolean   @default(false)
  status    ClaimStatus @default(OPEN)
  description String? 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt 

  item    Item  @relation(fields: [itemId], references: [itemId], onDelete: Cascade)
  claimer User  @relation("UserClaims", fields: [claimerId], references: [userId], onDelete: Cascade)
  threads Thread[]

  @@index([itemId])
  @@index([claimerId])
  @@index([status])
  @@index([finderId])
}

model Thread {
  threadId    String  @id @default(cuid())
  claimId     String  
  claimerId   String  
  finderId    String  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  archived    Boolean   @default(false)
  hidden      Boolean   @default(false)

  claim     Claim     @relation(fields: [claimId], references: [claimId], onDelete: Cascade)
  messages  Message[]

  @@index([claimId])
  @@index([claimerId])
  @@index([finderId])
}

model Message {
  messageId   String @id @default(cuid())
  threadId    String
  userId      String
  text        String
  createdAt   DateTime    @default(now())
  read        Boolean     @default(false)

  thread      Thread      @relation(fields: [threadId], references: [threadId], onDelete: Cascade)
  user        User        @relation("UserMessages", fields: [userId], references: [userId], onDelete: Cascade)

  @@index([threadId])
  @@index([userId])
  @@index([createdAt])
}

enum ItemStatus {
  LOST
  FOUND
  CLAIMED
}

enum ClaimStatus {
  OPEN 
  ACCEPTED
  DECLINED
}

model DeviceToken {
  tokenId   String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String   @default("ios")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

