// https://pris.ly/d/prisma-schema

// ============================================================================
// REQUIRED DATABASE SCHEMA CHANGES - MUST BE COMPLETED FOR APP COMPLETION
// ============================================================================
//
// ALL ITEMS BELOW ARE REQUIRED - Must be completed before app is finished
//
// 1. ClaimStatus ENUM MISMATCH (Line ~161-176)
//    - Current schema uses: PENDING, APPROVED, REJECTED, VERIFIED
//    - Backend code expects: OPEN, ACCEPTED, DECLINED
//    - ACTION: Replace enum values with: OPEN, ACCEPTED, DECLINED
//    - IMPACT: Breaks all claim-related functionality until fixed
//    - STATUS: REQUIRED
//
// 2. Claim Model MISSING FIELDS (Line ~101-119)
//    - Missing: finderId (String) - The user who found/reported the item
//    - Missing: handedOff (Boolean @default(false)) - Whether item has been physically handed off
//    - ACTION: Add these fields to Claim model (see TODO comments in model)
//    - IMPACT: markHandedOff() and confirmReceipt() methods will fail without these fields
//    - STATUS: REQUIRED
//
// 3. Category Field in Item Model (Line ~61-78)
//    - Missing: category field in Item model
//    - ACTION: Add category field (see TODO comment in Item model)
//    - IMPACT: Required for REQ-1.2 (category selection) and REQ-4.2 (category filtering)
//    - STATUS: REQUIRED
//
// After making ALL changes:
//   1. Create a new migration: npx prisma migrate dev --name complete_schema_updates
//   2. Regenerate Prisma client: npx prisma generate
//   3. Test all functionality (claims, items, categories) to ensure everything works
//
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId       String        @id @default(cuid())
  email        String        @unique
  name         String
  createdAt    DateTime      @default(now())
  items        Item[]
  notifications Notification[]
  claims       Claim[]       @relation("UserClaims")
  messages     Message[]     @relation("UserMessages")
  deviceTokens DeviceToken[]
}

model Item {
  itemId      String     @id @default(cuid())
  title       String
  description String
  status      ItemStatus @default(LOST)
  createdAt   DateTime   @default(now())
  userId      String
  user        User       @relation(fields: [userId], references: [userId], onDelete: Cascade)
  archives    Archive[]
  claims      Claim[]
  latitude    Float?
  longitude   Float?
  // TODO: ADD REQUIRED FIELD - category (String?) - Category for the item (e.g., "Electronics", "Clothing", "Books", etc.)
  // This is required for REQ-1.2 (category selection) and REQ-4.2 (category filtering)
  // category   String?

  @@index([userId])
  @@index([status])
  // TODO: Add index on category after field is added: @@index([category])
}

model Notification {
  notifId      String @id @default(cuid())
  userId       String 
  relatedUser         User @relation(fields : [userId], references : [userId], onDelete: Cascade)
  message      String
  timestamp    DateTime @default(now()) 
  read         Boolean @default(false)

  @@index([userId])
}

model Archive {
  archiveId    String   @id @default(cuid())
  itemId       String
  item         Item     @relation(fields: [itemId], references: [itemId], onDelete: Cascade)
  resolvedTime DateTime @default(now())
  reason       String? //Optional field

  @@index([itemId])
}

model Claim {
  claimId   String @id @default(cuid())
  itemId    String
  claimerId String
  // TODO: ADD REQUIRED FIELD - finderId (String) - The user who found/reported the item
  // This field is required - backend code expects it for claim operations
  // finderId String
  // TODO: ADD REQUIRED FIELD - handedOff (Boolean @default(false)) - Whether item has been physically handed off
  // This field is required - backend code uses it in markHandedOff() and confirmReceipt() methods
  // handedOff Boolean @default(false)
  status    ClaimStatus @default(PENDING) // TODO: Change default to OPEN after fixing enum to use OPEN/ACCEPTED/DECLINED
  description String? 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt 

  item    Item  @relation(fields: [itemId], references: [itemId], onDelete: Cascade)
  claimer User  @relation("UserClaims", fields: [claimerId], references: [userId], onDelete: Cascade)
  threads Thread[]

  @@index([itemId])
  @@index([claimerId])
  @@index([status])
  // TODO: Add index on finderId after field is added: @@index([finderId])
}

model Thread {
  threadId    String  @id @default(cuid())
  claimId     String  
  claimerId   String  
  finderId    String  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  archived    Boolean   @default(false)
  hidden      Boolean   @default(false)

  claim     Claim     @relation(fields: [claimId], references: [claimId], onDelete: Cascade)
  messages  Message[]

  @@index([claimId])
  @@index([claimerId])
  @@index([finderId])
}

model Message {
  messageId   String @id @default(cuid())
  threadId    String
  userId      String
  text        String
  createdAt   DateTime    @default(now())
  read        Boolean     @default(false)

  thread      Thread      @relation(fields: [threadId], references: [threadId], onDelete: Cascade)
  user        User        @relation("UserMessages", fields: [userId], references: [userId], onDelete: Cascade)

  @@index([threadId])
  @@index([userId])
  @@index([createdAt])
}

enum ItemStatus {
  LOST
  FOUND
  CLAIMED
}

enum ClaimStatus {
  // TODO: REQUIRED FIX - Update enum values to match backend code expectations
  // Current values (WRONG): PENDING, APPROVED, REJECTED, VERIFIED
  // Required values (CORRECT): OPEN, ACCEPTED, DECLINED
  // 
  // ACTION: Replace the enum values below with:
  //   OPEN      // Initial status when claim is created
  //   ACCEPTED  // When finder approves the claim
  //   DECLINED  // When finder denies the claim
  //
  // Remove these: PENDING, APPROVED, REJECTED, VERIFIED
  // This is REQUIRED - backend code uses OPEN/ACCEPTED/DECLINED throughout
  PENDING
  APPROVED
  REJECTED
  VERIFIED
}

model DeviceToken {
  tokenId   String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String   @default("ios")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

